---

# handle gnome extension tasks

- name: Get installed GNOME extensions
  ansible.builtin.shell:
    cmd: "ls -1d {{ extension_paths | join('* ') }}* | xargs -n1 basename | cat"
  register: ext_names_list
  changed_when: false
  failed_when: ext_names_list.rc not in [0, 2]

- name: Install extensions
  loop: "{{ gnome_extensions }}"
  when: extension.distro[ansible_distribution] is defined and extension.distro[ansible_distribution].name not in ext_names_list.stdout_lines
  ansible.builtin.include_tasks:
    file: present_extensions.yml
  loop_control:
    label: "{{ extension.name }}"
    loop_var: extension

- name: Remove unwanted gnome extensions
  become: true
  loop: "{{ obsolete_gnome_extensions }}"
  ansible.builtin.file:
    path: "/usr/share/gnome-shell/extensions/{{ item }}"
    state: absent

- name: Get installed GNOME extensions
  ansible.builtin.shell:
    cmd: "ls -1d {{ extension_paths | join('* ') }}* | xargs -n1 basename | cat"
  register: ext_names_list
  changed_when: false
  failed_when: ext_names_list.rc not in [0, 2]

- name: Enable installed extensions
  ansible.builtin.dconf:
    key: "/org/gnome/shell/enabled-extensions"
    value: "{{ ext_names_list.stdout_lines | to_json }}"

...
